{% extends "admin/change_list.html" %}
{% load static %}

{% block object-tools-items %}
  {{ block.super }}
  <li>
    <a href="{% url 'admin:auth_user_import_excel' %}" class="button">استيراد إكسل</a>
  </li>
  <li>
    <a href="{% url 'admin:auth_user_export_excel' %}" class="button">تصدير إكسل</a>
  </li>
  <li>
    <a href="{% url 'admin:auth_user_import_excel_template' %}" class="button">تحميل القالب</a>
  </li>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script>
// دالة للحصول على CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateUserStatus(selectElement) {
    const userId = selectElement.getAttribute('data-user-id');
    const url = selectElement.getAttribute('data-url');
    const newStatus = selectElement.value;
    const originalValue = selectElement.getAttribute('data-original-value') || selectElement.value;
    
    // حفظ القيمة الأصلية إذا لم تكن موجودة
    if (!selectElement.getAttribute('data-original-value')) {
        selectElement.setAttribute('data-original-value', originalValue);
    }
    
    // تعطيل الـ dropdown أثناء التحديث
    selectElement.disabled = true;
    const originalColor = selectElement.style.color;
    selectElement.style.color = '#999';
    
    // الحصول على CSRF token
    const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    
    // إرسال طلب AJAX
    const formData = new FormData();
    formData.append('status', newStatus);
    if (csrftoken) {
        formData.append('csrfmiddlewaretoken', csrftoken);
    }
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken || ''
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // تحديث الألوان حسب الحالة الجديدة
            const statusColors = {
                'Student': '#28a745',
                'Instructor': '#007bff',
                'Admin': '#dc3545',
                'Organization': '#6f42c1'
            };
            selectElement.style.color = statusColors[newStatus] || '#6c757d';
            
            // تحديث القيمة الأصلية
            selectElement.setAttribute('data-original-value', newStatus);
            
            // إظهار رسالة نجاح بصرياً
            const successMsg = document.createElement('span');
            successMsg.textContent = '✓ تم التحديث';
            successMsg.style.cssText = 'color: #28a745; margin-right: 5px; font-size: 12px;';
            selectElement.parentNode.insertBefore(successMsg, selectElement);
            setTimeout(() => successMsg.remove(), 2000);
        } else {
            // إرجاع القيمة الأصلية في حالة الفشل
            selectElement.value = originalValue;
            alert('فشل تحديث الحالة: ' + (data.error || 'خطأ غير معروف'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // إرجاع القيمة الأصلية في حالة الخطأ
        selectElement.value = originalValue;
        alert('حدث خطأ أثناء تحديث الحالة');
    })
    .finally(() => {
        // تفعيل الـ dropdown مرة أخرى
        selectElement.disabled = false;
    });
}

// تحديث الألوان عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    const statusDropdowns = document.querySelectorAll('.status-dropdown');
    const statusColors = {
        'Student': '#28a745',
        'Instructor': '#007bff',
        'Admin': '#dc3545',
        'Organization': '#6f42c1'
    };
    
    statusDropdowns.forEach(select => {
        const currentValue = select.value;
        select.style.color = statusColors[currentValue] || '#6c757d';
        
        // حفظ القيمة الأصلية
        if (!select.getAttribute('data-original-value')) {
            select.setAttribute('data-original-value', currentValue);
        }
    });

    const modal = document.createElement('div');
    modal.id = 'archive-modal';
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;'
        + 'background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:10000;';
    modal.innerHTML = `
        <div style="background:white;border-radius:12px;max-width:420px;width:90%;padding:24px;text-align:right;font-family:\'Tajawal\',sans-serif;">
            <h2 style="margin-top:0;margin-bottom:12px;color:#dc3545;">تأكيد المسح</h2>
            <p id="archive-modal-message" style="margin-bottom:20px;color:#333;font-size:15px;">
                هل أنت متأكد من مسح هذا المستخدم؟ سيتم إخفاؤه مع الاحتفاظ بجميع بياناته.
            </p>
            <div style="display:flex;justify-content:flex-end;gap:10px;">
                <button type="button" id="archive-cancel-btn" style="padding:8px 16px;border:none;border-radius:6px;background:#6c757d;color:white;cursor:pointer;">
                    إلغاء
                </button>
                <button type="button" id="archive-confirm-btn" style="padding:8px 16px;border:none;border-radius:6px;background:#dc3545;color:white;cursor:pointer;">
                    تأكيد المسح
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    const archiveButtons = document.querySelectorAll('.archive-trigger');
    let pendingArchiveUrl = null;

    archiveButtons.forEach(button => {
        button.addEventListener('click', function() {
            pendingArchiveUrl = this.getAttribute('data-archive-url');
            const username = this.getAttribute('data-username') || 'المستخدم';
            const message = document.getElementById('archive-modal-message');
            if (message) {
                message.textContent = `هل أنت متأكد من مسح المستخدم «${username}»؟ سيتم إخفاؤه مع الاحتفاظ بجميع بياناته.`;
            }
            modal.style.display = 'flex';
        });
    });

    const cancelBtn = document.getElementById('archive-cancel-btn');
    const confirmBtn = document.getElementById('archive-confirm-btn');

    if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            pendingArchiveUrl = null;
        });
    }

    if (confirmBtn) {
        confirmBtn.addEventListener('click', () => {
            if (pendingArchiveUrl) {
                window.location.href = pendingArchiveUrl;
            }
        });
    }

    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
            pendingArchiveUrl = null;
        }
    });
});
</script>
{% endblock %}